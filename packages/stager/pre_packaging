set -e

cd ${BUILD_DIR}/

export GOPATH=$PWD
export PATH=$GOPATH/bin:$PATH

mkdir -p $GOPATH/src/github.com/cloudfoundry-incubator
mv stager/ $GOPATH/src/github.com/cloudfoundry-incubator/stager/

cd $GOPATH/src/github.com/cloudfoundry-incubator/stager/
go get github.com/vito/gocart
gocart

cd $GOPATH

# etcd has a symlink to its parent, which tar does not take nicely to
# we only need it for tests anyway
rm -rf ./src/github.com/coreos/etcd

find . -name .git | xargs rm -rf

# don't package gocart; avoid recursive symlink when tarring
rm -rf $GOPATH/src/github.com/vito/gocart