#!/bin/bash

set -e -x -u

WORKING_DIR=`pwd`

bosh -n target $BOSH_TARGET

if ! bosh -n login $BOSH_USER $BOSH_PASSWORD; then
  echo "Creating director user"
  bosh -n -u admin -p admin create user $BOSH_USER $BOSH_PASSWORD
fi

case "$INFRASTRUCTURE" in
  aws)
    bosh upload stemcell light-bosh-stemcell-latest-aws-xen-ubuntu-trusty-go_agent.tgz --skip-if-exists
    bosh upload stemcell light-bosh-stemcell-latest-aws-xen-ubuntu-lucid-go_agent.tgz --skip-if-exists
    ;;
  *)
    echo "infrastructure '$INFRASTRUCTURE' not set up yet"
    exit 1
    ;;
esac

pushd ${WORKING_DIR}/cf-release
  echo cf | bosh create release
  bosh -n upload release --rebase --skip-if-exists || true

  ./generate_deployment_manifest ${INFRASTRUCTURE} \
    ${WORKING_DIR}/deployments-runtime/${DEPLOYMENT_NAME}/stubs/* > /tmp/cf-deployment.yml

  bosh deployment /tmp/cf-deployment.yml

  yes yes | bosh deploy
popd

echo diego | bosh create release
bosh -n upload release --rebase --skip-if-exists || true

./generate_deployment_manifest ${INFRASTRUCTURE} ${WORKING_DIR}/cf-release \
  ${WORKING_DIR}/deployments-runtime/${DEPLOYMENT_NAME}/stubs/* > /tmp/diego-deployment.yml

bosh deployment /tmp/diego-deployment.yml

yes yes | bosh deploy
