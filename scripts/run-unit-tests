#!/bin/bash

scripts_path=./$(dirname $0)
eval $($scripts_path/get_paths.sh)

SKIP_PACKAGES="./inigo"
SKIP_PACKAGES="$SKIP_PACKAGES,./auction/simulation"
SKIP_PACKAGES="$SKIP_PACKAGES,./benchmark-bbs"
SKIP_PACKAGES="$SKIP_PACKAGES,./candiedyaml"
SKIP_PACKAGES="$SKIP_PACKAGES,./cf-test-helpers"
SKIP_PACKAGES="$SKIP_PACKAGES,./diegocanaryapp"
SKIP_PACKAGES="$SKIP_PACKAGES,./dropsonde"
SKIP_PACKAGES="$SKIP_PACKAGES,./fezzik"
SKIP_PACKAGES="$SKIP_PACKAGES,./garden"
SKIP_PACKAGES="$SKIP_PACKAGES,./garden-linux"
SKIP_PACKAGES="$SKIP_PACKAGES,./diego-upgrade-stability-tests"
SKIP_PACKAGES="$SKIP_PACKAGES,./veritas"
SKIP_PACKAGES="$SKIP_PACKAGES,./vizzini"
ERROR_CODE=0

if [ -z "${RUN_VOLMAN}" ]; then
  SKIP_PACKAGES="$SKIP_PACKAGES,volman"
fi

if [ -z "${RUN_SQL_TESTS}" ]; then
  SKIP_PACKAGES="$SKIP_PACKAGES,./bbs/db/sqldb"
fi

if [ -n "$PACKAGE" ]; then
  ginkgo -r -p "$@" "./src/${PACKAGE}"
  exit $?
else
  pushd $DIEGO_RELEASE_DIR/src/github.com/cloudfoundry/gunk/diegonats/
    ginkgo -r -keepGoing -p -trace -randomizeAllSpecs -progress --race
    ERROR_CODE=$?
  popd

  if [ -n "${RUN_SQL_TESTS}" ]; then
    echo "Running BBS Cmd Suite against MySQL..."
    pushd $DIEGO_RELEASE_DIR/src/github.com/cloudfoundry-incubator/bbs
      USE_SQL=true ginkgo -p cmd/bbs
      let ERROR_CODE+=$?
    popd
  fi

  pushd $DIEGO_RELEASE_DIR/src/github.com/cloudfoundry-incubator/
    ginkgo -r -keepGoing -p -trace -randomizeAllSpecs -progress --race \
      -skipPackage=${SKIP_PACKAGES} "$@"
    let ERROR_CODE+=$?
  popd
  exit $ERROR_CODE
fi
