#!/bin/bash

set -e -x -u

stubs_path="${PWD}/${DEPLOYMENTS_DIR}/${DEPLOYMENT_NAME}/${STUBS_DIR}"

eval $(./diego-relelase/scripts/ci/bosh_config)
./diego-release/scripts/ci/bosh_setup

bosh -n create release --with-tarball
bosh -n upload release --rebase || true

./diego-release/scripts/generate-deployment-manifest ${INFRASTRUCTURE} cf-release ${stubs_path}/* > diego-deployment.yml
bosh deployment diego-deployment.yml

./diego-release/scripts/ci/emit-datadog-deploy-event started cf-${DEPLOYMENT_NAME} diego
if bosh -n deploy; then
  ./diego-release/scripts/ci/emit-datadog-deploy-event finished cf-${DEPLOYMENT_NAME} diego
else
  ./diego-release/scripts/ci/emit-datadog-deploy-event failed cf-${DEPLOYMENT_NAME} diego
  exit 1
fi
